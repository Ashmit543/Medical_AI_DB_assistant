# MediTrack AI Backend

FastAPI + LangGraph + Docling backend that orchestrates ingestion, summarization, RAG, and guardrail agents for MediTrack AI.

## Requirements

- Python 3.11+
- `uv` or `pip` for installs (`pip install uv` recommended)
- Supabase project with:
  - Storage bucket `patient_data`
  - Postgres tables (`patients`, `patient_vectors`, `patient_summaries`, `agent_audit_logs`)
  - Edge function or RPC `match_patient_vectors`
- HuggingFace API token with access to `mistralai/Mistral-7B-Instruct-v0.3`

## Installation

```bash
cd backend
uv pip install -r <(uv pip compile pyproject.toml)
# or
pip install -e .
```

Copy `../env.template` to `backend/.env` and populate secrets.

## Local Development

```bash
uvicorn app.main:app --reload --port 8000
```

## Key Endpoints

| Method | Path | Description |
| ------ | ---- | ----------- |
| `POST` | `/api/v1/ingest/upload` | Upload PDF/image, queue ingestion agent |
| `GET` | `/api/v1/patients` | List patients (data pulled directly from Supabase) |
| `GET` | `/api/v1/patients/{id}` | Patient detail + stored summaries |
| `POST` | `/api/v1/rag/query` | Patient-scoped medical Q&A with guardrails |

## Persistence Behavior

- **Patient endpoints** now read/write from Supabase (`patients`, `patient_summaries`).
- **Summaries** generated by the LangGraph agent are stored via `save_agent_summaries`.
- **Audit events** for ingestion, RAG retrieval, and guardrail validation are recorded in `agent_audit_logs`.
- Update Supabase RLS policies so that only backend service role (ingestion) bypasses row restrictions, while end-user queries rely on Supabase Auth.

## Deployment

- Railway config is tracked in `railway.toml`. Deploy with `railway up` or via the dashboard using the provided build/start commands.
- Remember to set all environment variables (see `env.template`) inside the Railway project.

## Tests

```bash
pytest
```

Add more tests in `tests/` for routers, services, and LangGraph workflows as you iterate.

